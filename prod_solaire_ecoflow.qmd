---
title: "Production panneaux solaires EcoFlow"
author: "Hugo Mabillard"
format: html
embed-resources: true
editor: visual
execute: 
  echo: false
  warning: false
  message: false
---

## Production des panneaux solaires EcoFlow

```{r}
#| label: Chargement 
#| echo: false 
#| warning: false 

# Chargement des librairies 
library(ggplot2) 
library(data.table) 
library(openxlsx) 
library(tidyr) 
library(dplyr) 
library(lubridate)

## Lecture des données
# Chemins d'accès aux dossiers de données

ddpath <- "C:/Users/doglo/OneDrive/Stat_R/Data/" # Laptop
# ddpath <- "C:/Users/Hugo/OneDrive/Stat_R/Data/" # Desktop


## Lecture des données de base

# Résultats quotidien

quot <- as.data.table(read.xlsx(paste(ddpath, "ecoflow.xlsx", sep=""), sheet="quotidien", colNames = TRUE, detectDates = TRUE))

# Résultats détaillés (horaires)

prod <- as.data.table(read.xlsx(paste(ddpath, "ecoflow.xlsx", sep=""), sheet="Production", colNames = TRUE, detectDates = TRUE, startRow = 1))
```

```{r}
#| label: Preparation
#| echo: false
#| warning: false

# ----------------------- #
# Préparation des données #
# ----------------------- #

# Date aujourd'hui
auj <- Sys.Date()
hier <- auj - 1
j90 <- auj - 90

# Données quotidiennes
quot[, an := year(date)][, mois := month(date)][, semaine := isoweek(date)][, trim := as.factor(quarter(date))][, jour := as.factor(wday(date, week_start = 1))][, mois_an := format(date, "%Y-%m")]

# Donnée horaires
prod[, an := year(date)][, mois := month(date)][, semaine := isoweek(date)][, trim := as.factor(quarter(date))][, jour := as.factor(wday(date, week_start = 1))]


## Format long
# Horaire
df_long <- prod %>%
  pivot_longer(
    cols = -c(date, an, mois, semaine, trim, jour), # Toutes les colonnes sauf dates
    names_to = "Heure", # Nouvelle colonne pour les heures
    values_to = "Production") %>%  # Valeurs de production horaire
  mutate(
    Heure = as.integer(Heure),
    date = as.Date(date)
  )

df_long <- as.data.table(df_long)

# Calcul du surplus théorique horaire (en kWh)
df_long[, surplus := ifelse(Production < 180, 0, Production - 180)]

surplus_jour <- df_long[, .(surplus = sum(surplus, na.rm=TRUE)), by="date"][order(date)]

# Journée production plus élevée
date_max <- quot[which.max(quot[, production]), date]
date_min <- quot[which.min(quot[date > "2025-05-16", production])+2, date]

prod_max <- quot[date == date_max, production]
prod_min <- quot[date == date_min, production]

prod_hier <- quot[date == hier, production]
```

Le jour où les panneaux ont produit le plus d'énergie fut le `r format(date_max, "%d %B %Y")` pour un total de `r prod_max` Wh.

À l'inverse, le `r format(date_min, "%d %B %Y")` les panneaux ont produit la plus faible quantité d'énergie (`r prod_min` Wh).

```{r}
#| label: Graph_prod_quot
#| echo: false
#| warning: false

quot2 <- subset(quot, date >= j90)
mean_prod_quot = mean(quot2[, production])

# Quotidien
ggplot(quot2, aes(x = date)) +
  geom_bar(aes(y = production), stat = "identity", fill = "#a7a824") + 
  geom_hline(yintercept = mean_prod_quot, linetype = "dotdash", color = "khaki4") +
  labs(x = "Date", y = "Production (en Wh)", title = "Production quotidienne (90 derniers jours)")

```

En moyenne, sur les 90 derniers jours, la production quotidienne s'élève à `r round(mean_prod_quot)` Wh.

Le graphique suivant compare la production entre le dernier jour (`r format(hier, "%d %B %Y")`; `r prod_hier` Wh) et le jour de production max. `r format(date_max, "%d %B %Y")`

```{r}
#| label: Graph_prod_quot_2
#| echo: false
#| warning: false

jour_ligne <- date_max
jour_barre <- auj - 1

df_ligne <- subset(df_long, date == jour_ligne)
df_barre <- subset(df_long, date == jour_barre)


ggplot() +
  geom_col(data = df_barre, aes(x = Heure, y = Production), fill = "#a7a824", alpha = 0.75) +
  geom_line(data = df_ligne, aes(x = Heure, y = Production), color = "#ffd700") +
  geom_point(data = df_ligne, aes(x = Heure, y = Production), color = "#ffd700", size = 2) +
#  geom_hline(yintercept = 180, linetype = "dashed", color = "khaki3") +
  labs(title = "Production horaire des panneaux solaires",
       x = "Heure de la journée",
       y = "Production (Wh)", 
       subtitle = paste("Barres =", jour_barre, "| Ligne =", jour_ligne)) +
  scale_x_continuous(breaks = seq(0, 23, 1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1))

```

### Graphiques pour la production hebdomadaire et mensuelle

```{r}
#| label: Graph_3
#| echo: false
#| warning: false


# Résumés des production hebdomadaires, mensuels, timestrielles, etc.
prod_hebd <- quot[, .(prod_kWh = (sum(production)/1000)), by = c("semaine", "an")][order(semaine, an)]
prod_hebd <- prod_hebd[2:.N, ]
prod_mens <- quot[, .(prod_kWh = (sum(production)/1000)), by = "mois_an"][order(mois_an)]
prod_mens <- prod_mens[2:.N,]
prod_trim <- quot[, .(prod_kWh = (sum(production)/1000)), by = c("trim", "an")][order(trim, an)]
prod_trim <- prod_trim[2:.N,]
prod_an <- quot[, .(prod_kWh = (sum(production)/1000)), by = "an"][order(an)]

# Calcul d'une moyenne
mean_prod_hebd = mean(prod_hebd[1:(.N-1), prod_kWh])
mean_prod_mens = mean(prod_mens[1:(.N-1), prod_kWh])


## Graphique
# Hebdomadaire
ggplot() +
  geom_col(data = prod_hebd, aes(x = semaine, y = prod_kWh), fill = "#ffd700", alpha = 0.85) +
  geom_hline(yintercept = mean_prod_hebd, linetype = "dashed", color = "khaki4") +
  geom_text(data = prod_hebd,
            aes(x = semaine, y = prod_kWh, label = round(prod_kWh)),
            vjust = 1.3,  # place le texte au-dessus des barres
            size = 4) +
  labs(title = "Production hebdomadaire (en kWh)",
       x = "Semaine",
       y = "Production (kWh)") +
  scale_x_continuous(labels = scales::number_format(accuracy = 1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5))

```

La production hebdomadaire moyenne (sans la semaine en cours) est de `r round(mean_prod_hebd,3)` kWh.

```{r}
#| label: Graph_4
#| echo: false
#| warning: false


# Mensuel
ggplot() +
  geom_col(data = prod_mens, aes(x = mois_an, y = prod_kWh), fill = "#ffd700", alpha = 0.85) +
  geom_hline(yintercept = mean_prod_mens, linetype = "dashed", color = "khaki4") +
  geom_text(data = prod_mens,
            aes(x = mois_an, y = prod_kWh, label = round(prod_kWh)),
            vjust = 1.3,  # place le texte au-dessus des barres
            size = 4) +
  labs(title = "Production mensuelle (en kWh)",
       x = "Mois",
       y = "Production (kWh)") +
  # scale_x_continuous(breaks = seq(5,12,1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5))
```

Alors que la production mensuelle moyenne (à partir de juin 2025; sans le mois en cours) est de `r round(mean_prod_mens,1)` kWh.

### Classements des 10 jours les plus productifs et les moins productifs

```{r}
#| label: tabl1
#| echo: false
#| warning: false

# Tableau des meilleurs et moins bons jours
quot2 <- subset(quot, date > "2025-05-16", select=c("date", "production"))
setorder(quot2, -production)

tab_plus <- quot2[1:10, ]
tab_moins <- quot2[(.N - 9):.N,]

setorder(tab_moins, production)

```

**Les 10 meilleurs jours**

| Date                   | Production (en Wh)           |
|------------------------|------------------------------|
| `r tab_plus[1, date]`  | `r tab_plus[1, production]`  |
| `r tab_plus[2, date]`  | `r tab_plus[2, production]`  |
| `r tab_plus[3, date]`  | `r tab_plus[3, production]`  |
| `r tab_plus[4, date]`  | `r tab_plus[4, production]`  |
| `r tab_plus[5, date]`  | `r tab_plus[5, production]`  |
| `r tab_plus[6, date]`  | `r tab_plus[6, production]`  |
| `r tab_plus[7, date]`  | `r tab_plus[7, production]`  |
| `r tab_plus[8, date]`  | `r tab_plus[8, production]`  |
| `r tab_plus[9, date]`  | `r tab_plus[9, production]`  |
| `r tab_plus[10, date]` | `r tab_plus[10, production]` |

**Les 10 moins bons jours**

| Date                    | Production (en Wh)            |
|-------------------------|-------------------------------|
| `r tab_moins[1, date]`  | `r tab_moins[1, production]`  |
| `r tab_moins[2, date]`  | `r tab_moins[2, production]`  |
| `r tab_moins[3, date]`  | `r tab_moins[3, production]`  |
| `r tab_moins[4, date]`  | `r tab_moins[4, production]`  |
| `r tab_moins[5, date]`  | `r tab_moins[5, production]`  |
| `r tab_moins[6, date]`  | `r tab_moins[6, production]`  |
| `r tab_moins[7, date]`  | `r tab_moins[7, production]`  |
| `r tab_moins[8, date]`  | `r tab_moins[8, production]`  |
| `r tab_moins[9, date]`  | `r tab_moins[9, production]`  |
| `r tab_moins[10, date]` | `r tab_moins[10, production]` |

### Résultats divers
```{r}
#| label: tabl2
#| echo: false
#| warning: false

# Nombre de jours inférieur ou supérieur à xx kWh / pour le futur pourra être transformé en tableau
nb_jour_inf <- quot[production < 1000, .N]
nb_jour_sup <- quot[production > 5000, .N]

```

Nombre de jours avec production supérieure à 5 kWh: `r nb_jour_inf`

Nombre de jours avec production inférieure à 1 kWh: `r nb_jour_sup`


## Consommation électrique

La consommation est mesurée par le *smart meter* Shelly Pro 3 EM. Ce dispositif ne mesure que la consommation dans l'appartement. Sont donc exclus la consommation dans la cave/buanderie (lave-linge et sèche-linge) ainsi que le garage (borne de recharge).

```{r}
#| label: preparation_conso
#| echo: false
#| warning: false

## Chargement des données
# Consommation quotidienne
conso_quot <- as.data.table(read.xlsx(paste(ddpath, "ecoflow.xlsx", sep=""), sheet="Shelly_quotidien", colNames = TRUE, detectDates = TRUE, startRow = 1))

# Consommation détaillée (horaires)
conso_horaire <- as.data.table(read.xlsx(paste(ddpath, "ecoflow.xlsx", sep=""), sheet="Shelly_horaire", colNames = TRUE, detectDates = TRUE, startRow = 1))

## Ajout des variables semaines, mois, trimestres, an
# Conso quotidienne
conso_quot[, an := year(date)][, mois := month(date)][, semaine := isoweek(date)][, trim := as.factor(quarter(date))][, jour := as.factor(wday(date, week_start = 1))]

# Conso horaire
conso_horaire[, an := year(date)][, mois := month(date)][, semaine := isoweek(date)][, trim := as.factor(quarter(date))][, jour := as.factor(wday(date, week_start = 1))]


## Format long
df_prod_long <- conso_horaire %>%
  pivot_longer(
    cols = -c(date, an, mois, semaine, trim, jour), # Toutes les colonnes sauf dates
    names_to = "Heure", # Nouvelle colonne pour les heures
    values_to = "Consommation") %>%  # Valeurs de production horaire
  mutate(
    Heure = as.integer(Heure),
    date = as.Date(date)
  )

df_prod_long <- as.data.table(df_prod_long)

# Journée production plus élevée
date_max <- conso_quot[which.max(conso_quot[, consommation]), date]
date_min <- conso_quot[which.min(conso_quot[, consommation]), date]


## Graphiques
mean_conso_quot = mean(conso_quot[, consommation])
mean_conso_kwh = mean_conso_quot/1000
sd_conso_quot = sd(conso_quot[, consommation])

jour_ligne <- date_max
jour_barre <- conso_quot[.N, date]

df_ligne <- subset(df_prod_long, date == jour_ligne)
df_barre <- subset(df_prod_long, date == jour_barre)

```

### Consommation électrique quotidienne et horaire

```{r}
#| label: graphique_conso
#| echo: false
#| warning: false

# Quotidien
ggplot(conso_quot, aes(x = date)) +
  geom_bar(aes(y = consommation), stat = "identity", fill = "#ca8f9c") + 
  geom_hline(yintercept = mean_conso_quot, linetype = "dotdash", color = "violetred") +
  labs(x = "Date", y = "Consommation (en Wh)", title = "Consommation quotidienne")

# Horaire

# Graphique horaire
ggplot() +
  geom_col(data = df_barre, aes(x = Heure, y = Consommation), fill = "#ca8f9c", alpha = 0.75) +
  geom_line(data = df_ligne, aes(x = Heure, y = Consommation), color = "violetred") +
  geom_point(data = df_ligne, aes(x = Heure, y = Consommation), color = "violetred", size = 2) +
  labs(title = "Consommation électrique horaire",
       x = "Heure",
       y = "Consommation (Wh)", 
       subtitle = paste("Barres =", jour_barre, "| Ligne =", jour_ligne)) +
  scale_x_continuous(breaks = seq(0, 23, 1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1))


```


La consommation quotidienne moyenne est de `r round(mean_conso_kwh,3)` kWh.


### Consommation électrique hebdomadaire et mensuelle

```{r}
#| label: graphique_conso1
#| echo: false
#| warning: false

## Résumés des consommations hebdomadaires, mensuels, timestrielles, etc.
conso_hebd <- conso_quot[, .(conso_kWh = (sum(consommation)/1000)), by = c("semaine", "an")][order(semaine, an)]
conso_hebd <- conso_hebd[2:.N, ]
conso_mens <- conso_quot[, .(conso_kWh = (sum(consommation)/1000)), by = c("mois", "an")][order(mois, an)]
conso_trim <- conso_quot[, .(conso_kWh = (sum(consommation)/1000)), by = c("trim", "an")][order(trim, an)]
conso_trim <- conso_trim[2:.N,]
conso_an <- conso_quot[, .(conso_kWh = (sum(consommation)/1000)), by = "an"][order(an)]

# Calcul d'une moyenne
mean_conso_hebd = mean(conso_hebd[1:(.N-1), conso_kWh])
mean_conso_mens = mean(conso_mens[1:(.N-1), conso_kWh])


## Graphique
# Hebdomadaire
ggplot() +
  geom_col(data = conso_hebd, aes(x = semaine, y = conso_kWh), fill = "#ca8f9c", alpha = 0.85) +
  geom_hline(yintercept = mean_conso_hebd, linetype = "dashed", color = "violetred") +
    geom_text(data = conso_hebd,
            aes(x = semaine, y = conso_kWh, label = round(conso_kWh)),
            vjust = 1.3,  # place le texte au-dessus des barres
            size = 4) +
  labs(title = "Consommation hebdomadaire (en kWh)",
       x = "Semaine",
       y = "Consommation (kWh)") +
  scale_x_continuous(labels = scales::number_format(accuracy = 1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5))

```

La consommation hebdomadaire moyenne (sans la semaine en cours) est de `r round(mean_conso_hebd,3)` kWh.

```{r}
#| label: graphique_conso2
#| echo: false
#| warning: false

# Mensuel
ggplot() +
  geom_col(data = conso_mens, aes(x = mois, y = conso_kWh), fill = "#ca8f9c", alpha = 0.85) +
  geom_hline(yintercept = mean_conso_mens, linetype = "dashed", color = "violetred") +
  geom_text(data = conso_mens,
            aes(x = mois, y = conso_kWh, label = round(conso_kWh)),
            vjust = 1.3,  # place le texte au-dessus des barres
            size = 4) +
  labs(title = "Consommation mensuelle (en kWh)",
       x = "Mois",
       y = "Consommation (kWh)") +
  # scale_x_continuous(labels = scales::number_format(accuracy = 1)) +
  scale_x_continuous(breaks = seq(11,12,1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5))

```

Alors que la consommation mensuelle moyenne (sans le mois en cours) est de `r round(mean_conso_mens,3)` kWh.


## Production et consommation

Graphique combiné production et consommation électrique du dernier jour complet.

```{r}
#| label: graphique_conso_prod
#| echo: false
#| warning: false

# Dernier jour complet: auj-1
jour_aff <- auj-1

# Sélection des données
df_conso_aff <- subset(df_prod_long, date == jour_aff, select=c('date', 'Heure', 'Consommation'))
df_prod_aff <- subset(df_long, date == jour_aff, select=c('date', 'Heure', 'Production'))


# Graphique
ggplot() +
  geom_area(data = df_conso_aff, aes(x = Heure, y = Consommation, fill = "Consommation"), alpha = 0.5) +
  geom_area(data = df_prod_aff, aes(x = Heure, y = Production, fill = "Production"), alpha = 0.5) +
  scale_fill_manual(name = "", values = c("Production" = "#a7a824", "Consommation" = "#ca8f9c")) +
  labs(title = "Production et consommation horaire", subtitle=paste0("du ", jour_aff), x = "Heure", y = "Wh") +
  scale_x_continuous(breaks = seq(0, 23, 1)) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), legend.position = "bottom")

```




## Autoconsommation

```{r}
#| label: autoconso1
#| echo: false
#| warning: false

# # Prod horaire
prod_horaire <- subset(prod, date > "2025-10-31" & date < auj)

num_cols <- grep("^[0-9]+$", names(prod_horaire), value = TRUE)
setnames(prod_horaire, num_cols, paste0("prod_", num_cols))


# # Conso horaire
setnames(conso_horaire, num_cols, paste0("conso_", num_cols))

conso_horaire[, an := NULL][, mois := NULL][, semaine := NULL][, trim := NULL][, jour := NULL]

# Fusion
dt_auto <- merge(prod_horaire, conso_horaire, by="date")

# Calculs
prod_cols  <- paste0("prod_", 0:23)
conso_cols <- paste0("conso_", 0:23)

prod_dt  <- dt_auto[, ..prod_cols]
conso_dt <- dt_auto[, ..conso_cols]

# Autoconsommation horaire
AC_dt <- as.data.table(Map(pmin, prod_dt, conso_dt))

setnames(AC_dt, paste0("AC_", 0:23))

dt_auto <- cbind(dt_auto, AC_dt)

# Autoconsommation totale
dt_auto[, AC_total := rowSums(.SD), .SDcols = paste0("AC_", 0:23)]

# Total production PV
dt_auto[, P_pv_total := rowSums(.SD), .SDcols = paste0("prod_", 0:23)]

# Total consommation
dt_auto[, P_load_total := rowSums(.SD), .SDcols = paste0("conso_", 0:23)]

# Taux d'autoconsommation
dt_auto[, tx_auto := ifelse(P_pv_total == 0, 0, (AC_total/P_pv_total)*100)]

# Taux de couverture
dt_auto[, tx_couverture := (AC_total/P_load_total)*100]

```

```{r}
#| label: autoconso_graph1
#| echo: false
#| warning: false

date_ref_max <- max(dt_auto[, date])
date_ref_min = date_ref_max - 31 

dt <- subset(dt_auto, date >= date_ref_min, select=c('date', 'tx_auto', 'tx_couverture'))

dt_long <- melt(
  dt,
  id.vars = "date",
  measure.vars = c("tx_auto", "tx_couverture"),
  variable.name = "type",
  value.name = "taux"
)

# Graphique taux d'autoconsommation et de couverture par jour
ggplot(data=dt_long, aes(x = date, y = taux, fill = type)) +
  geom_col(position = position_dodge()) +
  labs(title = "Autoconsommation", x = "Date", y = "Taux (en %)") +
  scale_fill_manual(name = "Taux",
    values = c("tx_auto" = "#1b9e77", "tx_couverture" = "#d95f02"),
    labels = c("tx_auto" = "Autoconsommation", "tx_couverture" = "Couverture")) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5)) +
  theme(legend.position = "bottom")


```


### Autoconsommation et taux de couverture mensuels

```{r}
#| label: autoconso2
#| echo: false
#| warning: false

# Préparation des données
dt <- subset(dt_auto, select = c(date, AC_total, P_pv_total, P_load_total))
dt[, mois := format(date, "%Y-%m")]

dt_mois <- dt[, .(prod_kWh = sum(P_pv_total, na.rm = TRUE), conso_kWh = sum(P_load_total, na.rm = TRUE), auto_kWh = sum(AC_total, na.rm = TRUE)), by = mois]

# Calcul des taux mensuels
dt_mois[, ':=' (taux_autoconso_mens = (auto_kWh / prod_kWh) * 100, taux_couverture_mens = (auto_kWh / conso_kWh) * 100)]

# Préparation du graphique
dt_long <- melt(
  dt_mois,
  id.vars = "mois",
  measure.vars = c("taux_autoconso_mens", "taux_couverture_mens"),
  variable.name = "type",
  value.name = "taux"
)


# Graphique taux d'autoconsommation et de couverture par jour
ggplot(data=dt_long, aes(x = mois, y = taux, fill = type)) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(
    aes(label = paste0(round(taux, 1), " %")),
    position = position_dodge(width = 0.9),
    vjust = -0.3,
    size = 3) +
  scale_y_continuous(
    labels = function(x) paste0(x, " %"),
    expand = expansion(mult = c(0, 0.1))  # espace pour le texte
    ) +
  labs(title = "Autoconsommation", x = "Date", y = "Taux (en %)") +
  scale_fill_manual(name = "Taux",
                    values = c("taux_autoconso_mens" = "#1b9e77", "taux_couverture_mens" = "#d95f02"),
                    labels = c("taux_autoconso_mens" = "Autoconsommation", "taux_couverture_mens" = "Couverture")) +
  theme_gray() +
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust = 1), plot.title = element_text(hjust=0.5)) +
  theme(legend.position = "bottom")


```



